<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Bus Stop Management</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif;}
    #map { width: 100%; height: 80vh; }
    #info { padding: 10px; height: 20vh; background:#f5f5f5; display:flex; flex-direction:column; }
    #stopList { overflow-y:auto; margin-top: 10px; flex:1; }
    #stopList div { padding:4px 0; cursor:pointer; border-bottom:1px solid #ddd; }
    button { padding:6px 12px; cursor:pointer; margin-top:5px; width:200px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <strong>Click on the map to add a bus stop</strong>
    <button id="saveBtn">Save All to Database</button>
    <div id="stopList"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBwaAqu8b6bchZ_9x4XLxZem-cixdKd35E",
      authDomain: "nextstop-cdab2.firebaseapp.com",
      projectId: "nextstop-cdab2",
      storageBucket: "nextstop-cdab2.appspot.com",
      messagingSenderId: "12223013337",
      appId: "1:12223013337:web:8ed340a114e576afc239c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Initialize map
    const map = L.map('map').setView([0,0], 2); // default fallback
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const busStops = [];
    const stopListDiv = document.getElementById('stopList');

    // Get user location and center map
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const { latitude, longitude } = position.coords;
        map.setView([latitude, longitude], 16);
        L.circle([latitude, longitude], {radius:50, color:'blue', fillColor:'blue', fillOpacity:0.3})
          .addTo(map)
          .bindPopup("Your Location")
          .openPopup();
      }, () => {
        alert("Could not get your location. Using default map view.");
      });
    } else {
      alert("Geolocation is not supported by your browser.");
    }

    // Render bus stop list
    function renderStopList() {
      stopListDiv.innerHTML = '';
      busStops.forEach((stop, index) => {
        const div = document.createElement('div');
        div.textContent = stop.name + ` (Lat: ${stop.latitude.toFixed(5)}, Lng: ${stop.longitude.toFixed(5)})`;
        div.addEventListener('click', () => {
          map.setView([stop.latitude, stop.longitude], 16);
        });
        stopListDiv.appendChild(div);
      });
    }

    // Add stop on map click
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      const stopName = prompt("Enter bus stop name:");
      if(!stopName) return;

      const marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup(`${stopName}<br>Lat: ${lat.toFixed(5)}<br>Lng: ${lng.toFixed(5)}`).openPopup();
      busStops.push({ name: stopName, latitude: lat, longitude: lng });

      renderStopList();
    });

    // Save stops to Firestore
    document.getElementById('saveBtn').addEventListener('click', async () => {
      if(busStops.length === 0) { alert('No points to save!'); return; }
      try {
        for(const stop of busStops){
          await addDoc(collection(db, 'busStops'), stop);
        }
        alert('Bus stops saved successfully!');
        busStops.length = 0;
        renderStopList();
      } catch (error) {
        console.error('Error saving points:', error);
        alert('Failed to save bus stops.');
      }
    });

  </script>
</body>
</html>
